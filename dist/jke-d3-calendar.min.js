!function(a,b,c){"use strict";var d=function(a){return a instanceof Date?c({hours:a.getHours(),minutes:a.getMinutes()}).toDate():c(a,"HH:mm").toDate()},e=function(a){return a instanceof Date?new Date(a.getFullYear(),a.getMonth(),a.getDate()):c(a).toDate()},f=function(a){return a instanceof Date?a:c(a).toDate()};a.widget("jke.calendar",{options:{margin:{top:20,right:0,bottom:10,left:40},height:600,width:800,startDate:"2014-01-02",endDate:"2014-01-07",startTime:"07:00",endTime:"18:00"},_create:function(){var a=this;a.svg=b.select(a.element[0]).append("svg").attr("height",a.options.height).attr("width",a.options.width),a.options.height=a.options.height-a.options.margin.top-a.options.margin.bottom,a.options.width=a.options.width-a.options.margin.left-a.options.margin.right,a.options.startDate=e(a.options.startDate),a.options.endDate=e(a.options.endDate),a.options.startTime=d(a.options.startTime),a.options.endTime=d(a.options.endTime),a.canvas=a.svg.append("g").attr("transform","translate("+(a.options.margin.left+.5)+","+(a.options.margin.top+.5)+")"),a.canvas.call(function(b){a.background=b.append("rect").classed("jke-calendar-background",!0).attr("height",a.options.height).attr("width",a.options.width).attr("x",0).attr("y",0)}),a.yScale=b.time.scale().domain([a.options.startTime,a.options.endTime]).range([0,a.options.height]),a.xScale=b.time.scale().domain([a.options.startDate,b.time.day.offset(a.options.endDate,1)]).range([0,a.options.width]),a.yAxisGenerator=b.svg.axis().scale(a.yScale).orient("left").outerTickSize(0).ticks(b.time.hour).tickFormat(b.time.format("%H:%M")),a.yAxis=a.canvas.append("g").classed("jke-calendar-axis-y",!0).call(a.yAxisGenerator),a.ySubGridGenerator=b.svg.axis().scale(a.yScale).orient("left").innerTickSize(-a.options.width).outerTickSize(0).ticks(b.time.minutes,30).tickFormat(""),a.ySubGrid=a.canvas.append("g").classed("jke-calendar-subGrid-y",!0).call(a.ySubGridGenerator),a.yGridGenerator=b.svg.axis().scale(a.yScale).orient("left").innerTickSize(-a.options.width).outerTickSize(0).ticks(b.time.hour).tickFormat(""),a.yGrid=a.canvas.append("g").classed("jke-calendar-grid-y",!0).call(a.yGridGenerator),a.getDayWidth=function(){var c=new Date;return a.xScale(b.time.day.offset(c,1))-a.xScale(c)},a.centerLabel=function(b){b.selectAll(".jke-calendar-axis-x text").attr("transform","translate("+a.getDayWidth()/2+",0)")},a.xAxisGenerator=b.svg.axis().scale(a.xScale).orient("top").outerTickSize(0).ticks(b.time.day).tickFormat(b.time.format("%a %d")),a.xAxis=a.canvas.append("g").classed("jke-calendar-axis-x",!0).call(a.xAxisGenerator).call(a.centerLabel),a.xGridGenerator=b.svg.axis().scale(a.xScale).orient("top").ticks(b.time.day).innerTickSize(-a.options.height).outerTickSize(0).tickFormat(""),a.xGrid=a.canvas.append("g").classed("jke-calendar-grid-x",!0).call(a.xGridGenerator),a.svg.call(function(b){a.clipMask=b.append("defs").append("svg:clipPath").attr("id","calendarClip").append("svt:rect").attr("x",0).attr("y",0).attr("height",a.options.height).attr("width",a.options.width)}),a.eventArea=a.canvas.append("g").classed("jke-calendar-events",!0).attr("clip-path","url(#calendarClip)"),a.options.data&&a._redraw(!1)},_destroy:function(){this.element.remove("svg")},_redraw:function(a){var c=this,d=a?800:0,e=a?300:0,f=function(a){return c.yScale(a._end)-c.yScale(a._start)},g=function(){return c.getDayWidth()-15},h=function(a){return"translate("+(c.xScale(a._day)+7)+","+c.yScale(a._start)+")"},i=function(a){return a.id},j=function(a){var c=b.time.format("%H:%M");return c(a._start)+" - "+c(a._end)},k=function(a){return a.notes},l=function(a){c._trigger("click",null,a.id)};c.yScale.domain([c.options.startTime,c.options.endTime]),c.xScale.domain([c.options.startDate,b.time.day.offset(c.options.endDate,1)]),c.ySubGridGenerator.innerTickSize(-c.options.width),c.yGridGenerator.innerTickSize(-c.options.width),c.xGridGenerator.innerTickSize(-c.options.height),c.yAxis.transition().duration(d).call(c.yAxisGenerator),c.ySubGrid.transition().duration(d).call(c.ySubGridGenerator),c.yGrid.transition().duration(d).call(c.yGridGenerator),c.xAxis.transition().duration(d).call(c.xAxisGenerator).call(c.centerLabel),c.xGrid.transition().duration(d).call(c.xGridGenerator);var m=c.eventArea.selectAll("rect").data(c.data,i);m.transition().duration(d).attr("width",g).attr("transform",h).attr("height",f),m.enter().append("rect").attr("x",0).attr("y",0).attr("height",0).attr("opacity",0).attr("width",g).attr("transform",h).on("click",l).transition().duration(d).attr("height",f).attr("opacity",1),m.exit().transition().duration(e).attr("width",0).remove();var n=c.eventArea.selectAll("line").data(c.data,i);n.transition().duration(d).attr("transform",h).attr("y2",f),n.enter().append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0).attr("transform",h).transition().duration(d).attr("y2",f),n.exit().transition().duration(e).attr("opacity",0).remove();var o=c.eventArea.selectAll("text.jke-calendar-time").data(c.data,i);o.text(j).transition().duration(d).attr("transform",h),o.enter().append("text").classed("jke-calendar-time",!0).text(j).attr("x",8).attr("y",18).attr("transform",h).attr("opacity",0).transition().duration(d).attr("opacity",1),o.exit().transition().duration(e).attr("opacity",0).remove();var p=c.eventArea.selectAll("text.jke-calendar-notes").data(c.data,i);p.text(k).transition().duration(d).attr("transform",h),p.enter().append("text").classed("jke-calendar-notes",!0).text(k).attr("x",8).attr("y",33).attr("transform",h).attr("opacity",0).transition().delay(d-e).duration(e).attr("opacity",1),p.exit().transition().duration(e).attr("opacity",0).remove()},setDateInterval:function(a,b){this.options.startDate=e(a),this.options.endDate=e(b),this._redraw(!0)},setTimeInterval:function(a,b){this.options.startTime=d(a),this.options.endTime=d(b),this._redraw(!0)},setDimensions:function(a,b){var c=this;c.svg.attr("height",b).attr("width",a),c.options.height=b-c.options.margin.top-c.options.margin.bottom,c.options.width=a-c.options.margin.left-c.options.margin.right,c.background.attr("height",c.options.height).attr("width",c.options.width),c.clipMask.attr("height",c.options.height).attr("width",c.options.width),c.yScale.range([0,c.options.height]),c.xScale.range([0,c.options.width]),this._redraw(!1)},updateData:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.startTime=f(b.startTime),b.endTime=f(b.endTime),b._day=e(b.startTime),b._start=d(b.startTime),b._end=d(b.endTime);this.data=a,this._redraw(!0)}})}($,d3,moment);