!function(a,b,c){"use strict";var d=function(a){return a instanceof Date?c({hours:a.getHours(),minutes:a.getMinutes()}).toDate():c(a,"HH:mm").toDate()},e=function(a){return a instanceof Date?new Date(a.getFullYear(),a.getMonth(),a.getDate()):c(a).toDate()},f=function(a){return a instanceof Date?a:c(a).toDate()};a.widget("jke.calendar",{options:{margin:{top:20,right:0,bottom:10,left:40},height:600,width:800,startDate:"2014-01-02",endDate:"2014-01-07",startTime:"07:00",endTime:"18:00"},_create:function(){var a=this;a.svg=b.select(a.element[0]).append("svg").attr("height",a.options.height).attr("width",a.options.width),a.options.height=a.options.height-a.options.margin.top-a.options.margin.bottom,a.options.width=a.options.width-a.options.margin.left-a.options.margin.right,a.options.startDate=e(a.options.startDate),a.options.endDate=e(a.options.endDate),a.options.startTime=d(a.options.startTime),a.options.endTime=d(a.options.endTime),a.canvas=a.svg.append("g").attr("transform","translate("+(a.options.margin.left+.5)+","+(a.options.margin.top+.5)+")"),a.canvas.call(function(b){a.background=b.append("rect").classed("jke-calendar-background",!0).attr("height",a.options.height).attr("width",a.options.width).attr("x",0).attr("y",0)}),a.yScale=b.time.scale().domain([a.options.startTime,a.options.endTime]).range([0,a.options.height]),a.xScale=b.time.scale().domain([a.options.startDate,b.time.day.offset(a.options.endDate,1)]).range([0,a.options.width]),a.yAxisGenerator=b.svg.axis().scale(a.yScale).orient("left").outerTickSize(0).ticks(b.time.hour).tickFormat(b.time.format("%H:%M")),a.yAxis=a.canvas.append("g").classed("jke-calendar-axis-y",!0).call(a.yAxisGenerator),a.ySubGridGenerator=b.svg.axis().scale(a.yScale).orient("left").innerTickSize(-a.options.width).outerTickSize(0).ticks(b.time.minutes,30).tickFormat(""),a.ySubGrid=a.canvas.append("g").classed("jke-calendar-subGrid-y",!0).call(a.ySubGridGenerator),a.yGridGenerator=b.svg.axis().scale(a.yScale).orient("left").innerTickSize(-a.options.width).outerTickSize(0).ticks(b.time.hour).tickFormat(""),a.yGrid=a.canvas.append("g").classed("jke-calendar-grid-y",!0).call(a.yGridGenerator),a.getDayWidth=function(){var c=new Date;return a.xScale(b.time.day.offset(c,1))-a.xScale(c)},a.centerLabel=function(b){b.selectAll(".jke-calendar-axis-x text").attr("transform","translate("+a.getDayWidth()/2+",0)")},a.xAxisGenerator=b.svg.axis().scale(a.xScale).orient("top").outerTickSize(0).ticks(b.time.day).tickFormat(b.time.format("%a %d")),a.xAxis=a.canvas.append("g").classed("jke-calendar-axis-x",!0).call(a.xAxisGenerator).call(a.centerLabel),a.xGridGenerator=b.svg.axis().scale(a.xScale).orient("top").ticks(b.time.day).innerTickSize(-a.options.height).outerTickSize(0).tickFormat(""),a.xGrid=a.canvas.append("g").classed("jke-calendar-grid-x",!0).call(a.xGridGenerator),a.svg.call(function(b){a.clipMask=b.append("defs").append("svg:clipPath").attr("id","calendarClip").append("svt:rect").attr("x",0).attr("y",0).attr("height",a.options.height).attr("width",a.options.width)}),a.eventArea=a.canvas.append("g").classed("jke-calendar-events",!0).attr("clip-path","url(#calendarClip)"),a.options.data&&a._redraw()},_destroy:function(){this.element.remove("svg")},_redraw:function(){var a=this,c=function(b){return a.yScale(b._end)-a.yScale(b._start)},d=function(){return a.getDayWidth()-15},e=function(b){return"translate("+(a.xScale(b._day)+7)+","+a.yScale(b._start)+")"},f=function(a){return a.id},g=function(a){var c=b.time.format("%H:%M");return c(a._start)+" - "+c(a._end)},h=function(a){return a.notes},i=function(b){a._trigger("click",null,b.id)};a.yScale.domain([a.options.startTime,a.options.endTime]),a.xScale.domain([a.options.startDate,b.time.day.offset(a.options.endDate,1)]),a.ySubGridGenerator.innerTickSize(-a.options.width),a.yGridGenerator.innerTickSize(-a.options.width),a.xGridGenerator.innerTickSize(-a.options.height),a.yAxis.transition().duration(800).call(a.yAxisGenerator),a.ySubGrid.transition().duration(800).call(a.ySubGridGenerator),a.yGrid.transition().duration(800).call(a.yGridGenerator),a.xAxis.transition().duration(800).call(a.xAxisGenerator).call(a.centerLabel),a.xGrid.transition().duration(800).call(a.xGridGenerator);var j=a.eventArea.selectAll("rect").data(a.data,f);j.transition().duration(800).attr("width",d).attr("transform",e).attr("height",c),j.enter().append("rect").attr("x",0).attr("y",0).attr("height",0).attr("opacity",0).attr("width",d).attr("transform",e).on("click",i).transition().duration(800).attr("height",c).attr("opacity",1),j.exit().transition().duration(300).attr("height",0).remove();var k=a.eventArea.selectAll("line").data(a.data,f);k.transition().duration(800).attr("transform",e).attr("y2",c),k.enter().append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0).attr("transform",e).transition().duration(800).attr("y2",c),k.exit().transition().duration(300).attr("y2",0).remove();var l=a.eventArea.selectAll("text.jke-calendar-time").data(a.data,f);l.text(g).transition().duration(800).attr("transform",e),l.enter().append("text").classed("jke-calendar-time",!0).text(g).attr("x",8).attr("y",18).attr("transform",e).attr("opacity",0).transition().duration(800).attr("opacity",1),l.exit().transition().duration(200).attr("opacity",0).remove();var m=a.eventArea.selectAll("text.jke-calendar-notes").data(a.data,f);m.text(h).transition().duration(800).attr("transform",e),m.enter().append("text").classed("jke-calendar-notes",!0).text(h).attr("x",8).attr("y",33).attr("transform",e).attr("opacity",0).transition().delay(500).duration(200).attr("opacity",1),m.exit().transition().duration(200).attr("opacity",0).remove()},setDateInterval:function(a,b){this.options.startDate=e(a),this.options.endDate=e(b),this._redraw()},setTimeInterval:function(a,b){this.options.startTime=d(a),this.options.endTime=d(b),this._redraw()},setDimensions:function(a,b){var c=this;c.svg.transition().duration(800).attr("height",b).attr("width",a),c.options.height=b-c.options.margin.top-c.options.margin.bottom,c.options.width=a-c.options.margin.left-c.options.margin.right,c.background.transition().duration(800).attr("height",c.options.height).attr("width",c.options.width),c.clipMask.transition().duration(800).attr("height",c.options.height).attr("width",c.options.width),c.yScale.range([0,c.options.height]),c.xScale.range([0,c.options.width]),this._redraw()},updateData:function(a){for(var b,c=0;c<a.length;c++)b=a[c],b.startTime=f(b.startTime),b.endTime=f(b.endTime),b._day=e(b.startTime),b._start=d(b.startTime),b._end=d(b.endTime);this.data=a,this._redraw()}})}($,d3,moment);